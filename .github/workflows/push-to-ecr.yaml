name: Build-Scan-Push-to-ECR

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  PRIMARY_REGION: ${{ secrets.AWS_REGION_PRIMARY }}
  SECONDARY_REGION: ${{ secrets.AWS_REGION_SECONDARY }}

  COMPONENTS: "frontend-web catalog pricing inventory orders cart payments-orchestrator shipping notifications"

jobs:
  build_scan_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # ---------- Configure AWS creds (OIDC) ----------
      - name: Configure AWS credentials (primary)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION_PRIMARY }}

      # ---------- Install Grype ----------
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
          | sudo sh -s -- -b /usr/local/bin
          grype version

      # ---------- Login to ECR (primary) ----------
      - name: Login to ECR (primary)
        run: |
          aws ecr get-login-password --region "$PRIMARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com"

      # ---------- Build, scan, push (primary) ----------
      - name: Build, scan, push (primary)
        run: |
          set -e
          for c in $COMPONENTS; do
            if [ "$c" = "frontend-web" ]; then
              dir="frontend/web"
            else
              dir="services/$c"
            fi

            IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$c:$IMAGE_TAG"

            echo "=== Building $c ==="
            docker build -t "$IMAGE_URI" "$dir"

            echo "=== Grype scan $c ==="
            grype "$IMAGE_URI" --only-fixed --fail-on critical

            echo "=== Push $c to primary ==="
            docker push "$IMAGE_URI"
          done

      # ---------- Login to ECR (secondary) ----------
      - name: Login to ECR (secondary)
        run: |
          aws ecr get-login-password --region "$SECONDARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com"

      # ---------- Tag & push (secondary) ----------
      - name: Tag & push (secondary)
        run: |
          set -e
          for c in $COMPONENTS; do
            PRIMARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$c:$IMAGE_TAG"
            SECONDARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com/$c:$IMAGE_TAG"

            docker tag "$PRIMARY_URI" "$SECONDARY_URI"
            docker push "$SECONDARY_URI"
          done
