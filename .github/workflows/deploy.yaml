name: Build-Scan-Push-Deploy

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  PRIMARY_REGION: ${{ secrets.AWS_REGION_PRIMARY }}
  SECONDARY_REGION: ${{ secrets.AWS_REGION_SECONDARY }}

  # Repo/image names (must exist as ECR repositories in both regions)
  COMPONENTS: "frontend-web catalog pricing inventory orders cart payments-orchestrator shipping notifications"

  # ECS (needed for deploy)
  ECS_CLUSTER_PRIMARY: ${{ secrets.ECS_CLUSTER_PRIMARY }}
  ECS_CLUSTER_SECONDARY: ${{ secrets.ECS_CLUSTER_SECONDARY }}
  ECS_EXEC_ROLE_ARN: ${{ secrets.ECS_EXEC_ROLE_ARN }}
  ECS_TASK_ROLE_ARN: ${{ secrets.ECS_TASK_ROLE_ARN }}
  CW_LOG_GROUP: ${{ secrets.CW_LOG_GROUP }}

jobs:
  build_scan_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # ---------- Configure AWS creds (OIDC) ----------
      - name: Configure AWS credentials (primary)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION_PRIMARY }}

      # ---------- Unit tests (best-effort) ----------
      # If you have root-level tests, add them here.
      # For each Node service/Next.js, it runs npm test if defined.
      - name: Run tests (if present)
        run: |
          set -e
          for c in $COMPONENTS; do
            if [ "$c" = "frontend-web" ]; then
              dir="frontend/web"
            else
              dir="services/$c"
            fi

            if [ -f "$dir/package.json" ]; then
              echo "=== Testing $c ==="
              (cd "$dir" && npm ci && npm test --if-present)
            fi
          done

      # ---------- Install Trivy ----------
      - name: Install Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          version: latest

      # ---------- Login to ECR (primary) ----------
      - name: Login to ECR (primary)
        run: |
          aws ecr get-login-password --region "$PRIMARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com"

      # ---------- Build, scan, push to primary ----------
      - name: Build, scan, push (primary)
        run: |
          set -e
          for c in $COMPONENTS; do
            if [ "$c" = "frontend-web" ]; then
              dir="frontend/web"
            else
              dir="services/$c"
            fi

            IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$c:$IMAGE_TAG"
            echo "=== Building $c from $dir ==="
            docker build -t "$IMAGE_URI" "$dir"

            echo "=== Trivy scan $c ==="
            trivy image --severity HIGH,CRITICAL --exit-code 1 "$IMAGE_URI"

            echo "=== Push $c to primary ==="
            docker push "$IMAGE_URI"
          done

      # ---------- Login to ECR (secondary) ----------
      - name: Login to ECR (secondary)
        run: |
          aws ecr get-login-password --region "$SECONDARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com"

      # ---------- Tag & push to secondary ----------
      - name: Tag & push (secondary)
        run: |
          set -e
          for c in $COMPONENTS; do
            PRIMARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$c:$IMAGE_TAG"
            SECONDARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com/$c:$IMAGE_TAG"
            echo "=== Tagging $c for secondary ==="
            docker tag "$PRIMARY_URI" "$SECONDARY_URI"
            echo "=== Push $c to secondary ==="
            docker push "$SECONDARY_URI"
          done

      # ---------- Deploy to ECS PRIMARY (register task def + update service) ----------
      - name: Deploy ECS (primary)
        if: ${{ secrets.ECS_CLUSTER_PRIMARY != '' }}
        run: |
          set -e

          deploy_one () {
            local component="$1"
            local taskdef_file="$2"
            local family="$3"
            local service_name="$4"

            echo "=== Rendering taskdef for $component in $PRIMARY_REGION ==="

            # Replace placeholders for primary region
            sed -e "s|<ACCOUNT_ID>|$AWS_ACCOUNT_ID|g" \
                -e "s|<REGION>|$PRIMARY_REGION|g" \
                -e "s|<EXEC_ROLE_ARN>|$ECS_EXEC_ROLE_ARN|g" \
                -e "s|<TASK_ROLE_ARN>|$ECS_TASK_ROLE_ARN|g" \
                -e "s|<LOG_GROUP_NAME>|$CW_LOG_GROUP|g" \
                "$taskdef_file" > rendered.json

            # Replace image tag in rendered.json (latest -> sha)
            # Assumes image ends with :latest in template
            sed -i "s|:latest|:$IMAGE_TAG|g" rendered.json

            echo "=== Register task definition: $family ==="
            TASKDEF_ARN=$(aws ecs register-task-definition \
              --region "$PRIMARY_REGION" \
              --cli-input-json file://rendered.json \
              --query "taskDefinition.taskDefinitionArn" \
              --output text)

            echo "=== Update service: $service_name ==="
            aws ecs update-service \
              --region "$PRIMARY_REGION" \
              --cluster "$ECS_CLUSTER_PRIMARY" \
              --service "$service_name" \
              --task-definition "$TASKDEF_ARN" \
              --force-new-deployment

            echo "=== Wait service stable: $service_name ==="
            aws ecs wait services-stable \
              --region "$PRIMARY_REGION" \
              --cluster "$ECS_CLUSTER_PRIMARY" \
              --services "$service_name"
          }

          # Map ECS service names (adjust to your actual service names)
          deploy_one "frontend-web" "infra/taskdef/frontend-web.json" "cloudretail-frontend-web" "cloudretail-frontend-web-svc"
          deploy_one "catalog" "infra/taskdef/catalog.json" "cloudretail-catalog" "cloudretail-catalog-svc"
          deploy_one "pricing" "infra/taskdef/pricing.json" "cloudretail-pricing" "cloudretail-pricing-svc"
          deploy_one "inventory" "infra/taskdef/inventory.json" "cloudretail-inventory" "cloudretail-inventory-svc"
          deploy_one "orders" "infra/taskdef/orders.json" "cloudretail-orders" "cloudretail-orders-svc"
          deploy_one "cart" "infra/taskdef/cart.json" "cloudretail-cart" "cloudretail-cart-svc"
          deploy_one "payments-orchestrator" "infra/taskdef/payments-orchestrator.json" "cloudretail-payments-orchestrator" "cloudretail-payments-orchestrator-svc"
          deploy_one "shipping" "infra/taskdef/shipping.json" "cloudretail-shipping" "cloudretail-shipping-svc"
          deploy_one "notifications" "infra/taskdef/notifications.json" "cloudretail-notifications" "cloudretail-notifications-svc"

      # ---------- Deploy to ECS SECONDARY ----------
      - name: Deploy ECS (secondary)
        if: ${{ secrets.ECS_CLUSTER_SECONDARY != '' }}
        run: |
          set -e

          deploy_one () {
            local component="$1"
            local taskdef_file="$2"
            local family="$3"
            local service_name="$4"

            echo "=== Rendering taskdef for $component in $SECONDARY_REGION ==="

            sed -e "s|<ACCOUNT_ID>|$AWS_ACCOUNT_ID|g" \
                -e "s|<REGION>|$SECONDARY_REGION|g" \
                -e "s|<EXEC_ROLE_ARN>|$ECS_EXEC_ROLE_ARN|g" \
                -e "s|<TASK_ROLE_ARN>|$ECS_TASK_ROLE_ARN|g" \
                -e "s|<LOG_GROUP_NAME>|$CW_LOG_GROUP|g" \
                "$taskdef_file" > rendered.json

            sed -i "s|:latest|:$IMAGE_TAG|g" rendered.json

            TASKDEF_ARN=$(aws ecs register-task-definition \
              --region "$SECONDARY_REGION" \
              --cli-input-json file://rendered.json \
              --query "taskDefinition.taskDefinitionArn" \
              --output text)

            aws ecs update-service \
              --region "$SECONDARY_REGION" \
              --cluster "$ECS_CLUSTER_SECONDARY" \
              --service "$service_name" \
              --task-definition "$TASKDEF_ARN" \
              --force-new-deployment

            aws ecs wait services-stable \
              --region "$SECONDARY_REGION" \
              --cluster "$ECS_CLUSTER_SECONDARY" \
              --services "$service_name"
          }

          deploy_one "frontend-web" "infra/taskdef/frontend-web.json" "cloudretail-frontend-web" "cloudretail-frontend-web-svc"
          deploy_one "catalog" "infra/taskdef/catalog.json" "cloudretail-catalog" "cloudretail-catalog-svc"
          deploy_one "pricing" "infra/taskdef/pricing.json" "cloudretail-pricing" "cloudretail-pricing-svc"
          deploy_one "inventory" "infra/taskdef/inventory.json" "cloudretail-inventory" "cloudretail-inventory-svc"
          deploy_one "orders" "infra/taskdef/orders.json" "cloudretail-orders" "cloudretail-orders-svc"
          deploy_one "cart" "infra/taskdef/cart.json" "cloudretail-cart" "cloudretail-cart-svc"
          deploy_one "payments-orchestrator" "infra/taskdef/payments-orchestrator.json" "cloudretail-payments-orchestrator" "cloudretail-payments-orchestrator-svc"
          deploy_one "shipping" "infra/taskdef/shipping.json" "cloudretail-shipping" "cloudretail-shipping-svc"
          deploy_one "notifications" "infra/taskdef/notifications.json" "cloudretail-notifications" "cloudretail-notifications-svc"
