name: Build-Push-inventory-to-ECR

on:
  push:
    branches: ["master"]
    # Optional: Only trigger if files in the inventory folder change
    paths:
      - 'services/inventory/**'

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  PRIMARY_REGION: ${{ secrets.AWS_REGION_PRIMARY }}
  SECONDARY_REGION: ${{ secrets.AWS_REGION_SECONDARY }}
  # Updated to only include inventory
  COMPONENT: "inventory"

jobs:
  build_push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

      # ---------- Configure AWS credentials (OIDC) ----------
      - name: Configure AWS credentials (primary)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION_PRIMARY }}

      # ---------- Login to ECR (primary) ----------
      - name: Login to ECR (primary)
        run: |
          aws ecr get-login-password --region "$PRIMARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com"

      # ---------- Build & push to primary ----------
      - name: Build & push (primary)
        run: |
          set -e
          # Points specifically to your inventory folder
          DIR="services/$COMPONENT"
          IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$COMPONENT:$IMAGE_TAG"

          echo "=== Building $COMPONENT ==="
          docker build -t "$IMAGE_URI" "$DIR"

          echo "=== Pushing $COMPONENT to primary ==="
          docker push "$IMAGE_URI"

      # ---------- Login to ECR (secondary) ----------
      - name: Login to ECR (secondary)
        run: |
          aws ecr get-login-password --region "$SECONDARY_REGION" \
          | docker login --username AWS --password-stdin \
            "$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com"

      # ---------- Tag & push to secondary ----------
      - name: Tag & push (secondary)
        run: |
          set -e
          PRIMARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$PRIMARY_REGION.amazonaws.com/$COMPONENT:$IMAGE_TAG"
          SECONDARY_URI="$AWS_ACCOUNT_ID.dkr.ecr.$SECONDARY_REGION.amazonaws.com/$COMPONENT:$IMAGE_TAG"

          echo "=== Tagging $COMPONENT for secondary ==="
          docker tag "$PRIMARY_URI" "$SECONDARY_URI"
          
          echo "=== Pushing $COMPONENT to secondary ==="
          docker push "$SECONDARY_URI"